<!--
    Synopsis of all incoming reports from mobile users. Displays all information 
    in a condensed fashion in an effective yet space-efficient design. Allows
    the ability for detailed filtering of reports. 
    Contents:
    - Scrollable list of reports
        - Icons displaying status of unopened/unsolved/solved
        - Summary of data fields
    - Page controls to manipulate list of reports
    - Filtering options
    - Search button to apply filters
    - [Standardized] Bottom border
    - [Standardized] Navagation bar - set to Dashboard
-->

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>CruzSafe: Reports</title>
        <!--Import Stylesheet-->
        <link
            href="./stylesheets/main.css"
            type="text/css"
            rel="stylesheet"
        />
        <link
            href="./stylesheets/reports.css"
            type="text/css"
            rel="stylesheet"
        />
        <!--Imports External Icon Font Library-->
        <!--TODO: Install all needed Icons & remove external dependency-->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        />

    </head>
    <body>
        <script src="./libs/NavLib.js"></script>

        <!--reportListRefresher code-->
        <input type="hidden" id= "storedTS">
        <script>
            var tid = "";
            document.addEventListener('DOMContentLoaded', function(){
                // When DOM is loaded
                setupReports(document); // Setup reports initially
                var latestTS = document.getElementById("latestTS");
                getTS(document, "storedTS", 1);// Gets the initial TS and sets up listener
            });

            // Sets up Timer to call function every 10 seconds;
            // Time is in milliseconds
            if(tid === ""){
                tid = setInterval(checkTS,5000);
            }

            function checkTS(){
                // Process to test for a different timestamp.
                getTS(document, "storedTS", 0);
            }
        </script>
        <!--End reportListRefresher code-->

        <!--Header-->
        <div class="topnav" id="topnav" style="height:100">
            <a href="./homepage.html"
                ><i class="fa fa-home" aria-hidden="true"></i> Home</a
            >
            <a class="active" href="./reports.html"
                ><i class="fa fa-folder" aria-hidden="true"></i> Reports</a
            >
            <a href="./analytics.html"
                ><i class="fa fa-pie-chart" aria-hidden="true"></i> Analytics</a
            >
            <a href="./admin.html">
                <i class="fa fa-user-circle-o" aria-hidden="true"></i> Admin</a>
            <a href="./"
                ><i class="fa fa-sign-out" aria-hidden="true"></i> Sign-Out</a
            >
            <!-- <a href="javascript:void(0);" class="icon" onclick="toggleTopNav()">
                <i class="fa fa-bars"></i>
            </a> -->
        </div>

        <!--Body-->
        <div class="row">
            <div id="filterOptions" class="text_box">
                <h2>Filters:</h2>
                <input id = "filterTag" placeholder="Tag"></input><br/>
                <input id = "filterIncidentID" placeholder="Incident id(s)"></input> <br/>
                <input id = "filterDate" placeholder="Report date (MM-DD-YYYY)"></input><br/>
                <input id = "filterTime" placeholder="Report time (HH:MM)"></input><br/>
                <input id = "filterBody" placeholder="Body contains"></input><br/>
                <input id = "filterLocation" placeholder="Location"></input><br/>
                <input id = "filterCoordinates" placeholder="Coordinates"></input><br/>         
                <input id = "filterMobileID" placeholder="Mobile user id(s)"></input><br/>
                <input  id = "filterFirstName" placeholder="First name"></input><br/>
                <input id = "filterLastName" placeholder="Last name"></input><br/>
                <input  id = "filterEmail" placeholder="Email (Enter xxx@ucsc.edu)"></input><br/>
                <input  id = "filterPhone" placeholder="Phone (Enter 555555555)"></input><br/>
                <input id = "filterExpire" placeholder="Expiring within day"></input><br/><br/>
                <p>Location method: </p>
                <select id="filterUnchangedLocation" autocomplete="off">
                    <option value="" selected="selected">Any</option>
                    <option value="device reported">Device reported</option>
                    <option value="pinned location">Pinned location</option>
                </select>
                <br/>
                <p>Status:
                        <select id="filterStatus" autocomplete="off">
                            <option value="" selected="selected">Any</option>
                            <option value="New">New</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </p>
                    <br/>
                <p>Attachments: </p>
                <select id="filterAttachments" autocomplete="off">
                    <option value="" selected="selected">Any</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <br/>
                <br/>   
                <button onclick = "applyFilters()" id = "applyFilters" class="btn navy rounded">Apply Filters</button> 
                <button onclick = "location.reload()" id = "resetPage" class="btn navy rounded">Reset</button>
            </div>

            <!--Filter Code-->
            <script>
                /*
                    Takes in button ID that initiates the dropdown; this button will have its text replaced by given text.
                    This text will be read by report.js upon selecting of apply filters; 
                    if it is (Not chosen), nothing is added to dictionary.
                */
                function applySelected(dropbtnID, btn){
                    dropbtn = document.getElementById(dropbtnID);
                    dropbtn.innerHTML = btn.innerHTML;
                }

                /*
                    Grabs all of the text in filter fields and converts into a dictionary 
                    which then sends to reports.js which calls API and modifies the list of reports.
                */
                function applyFilters(){
                    // List of all ids of elements to grab text from. 
                    const filterElements = ["filterTag","filterIncidentID","filterDate","filterTime","filterStatus","filterBody","filterLocation","filterCoordinates","filterUnchangedLocation","filterAttachments","filterMobileID","filterFirstName","filterLastName","filterEmail","filterPhone","filterExpire"];
                    var filterDict = {};  // Create the dictionary. 
                    for(i = 0; i < filterElements.length;i++) {// fill the dictionary
                        element = document.getElementById(filterElements[i]);
                        // With a proper dropdown menu, no longer need to check for the text of the old one
                        // element.value should return the value of any input type elements (text fields + dropboxes qualify)
                        var text = element.value; 
                        if(text != ""){  // If not empty/not chosen for dropdown
                            filterDict[filterElements[i]] = text; // filterElement:value
                        }
                        else{
                            filterDict[filterElements[i]] = null;
                        }
                    }
                    // Error checking area! Add more modules in the future.
                    // NOte: this one is broken. 
                    if((Number.isInteger(filterDict["filterIncidentID"] == false) && filterDict["filterIncidentID"] != null)){
                        alert('Incident ID entry must be a number!');
                    }
                    // elif(){}
                    else{
                        filterReports(filterDict, document)// Else all items are good. Send to filterReports.
                    }
                }
            </script>
            <!--Filter code end-->

            <div id="reportColumn" class="column">
                <div id= "reportHeader">
                    <span id = buttonResolvedUnresolved>Status</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonIncidentIDText> Inc#</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonReportTSText>Date + Time</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonTagText>Tag</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonLocationText>Location</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonFullNameText>Last, First name</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonBodyText>Body</span>
                </div>
                <div id= "reportList"></div> <!--Div to be filled by setupReports()-->
                <center>
                    <div id= "navigationButtons">
                        <button id="firstBtn" class="btn navy rounded" onClick="firstLast('first')">First</button>
                        <button id="prevBtn" class="btn navy rounded" onClick="nextPrev(-1)">Prev</button>
                        <div id="reportListIndicators"></div> <!--Div to be filled by setupReports()-->
                        <button id="nextBtn" class="btn navy rounded" onClick="nextPrev(1)">Next</button>
                        <button id="lastBtn" class="btn navy rounded" onClick="firstLast('last')">Last</button>
                    </div>
                </center>
            </div>
        </div>
        <!--Footer-->
        <!-- <div class="footer">
            <div style="margin-top:5; margin-bottom:5">
                <p style="text-align: center">CruzSafe</p>
            </div>
        </div> -->
        <!--REPORT MODAL; USE WITH "report.js" METHODS!-->
        <center>
            <div id="report" class="modal">
                <form class="modal-content animate" method="POST">
                    <div class="imgcontainer">
                        <!--Close Button; closes Modal-->
                        <span
                            id = "closeReport"
                            onclick="hideReport(0)"
                            class="close"
                            title="Close Modal"
                            ><i class="fa fa-times"></i
                        ></span>
                        <!--Report Content-->
                        <div id="reportContent" class="container">
                            <div class="reportRow">
                                <div id="column1" class="reportColumn1">
                                    <p>
                                        <b>Incident:</b> #<span id = "incidentID"></span> <b id="resolvedUnresolved"></b>
                                    </p>
                                    <p><b>Date:</b> <span id="reportTS"></span></p>
                                    <p><b>Time:</b> <span id="reportTS2"></span></p>
                                    <p><b>Location:</b> <span id="location"></span> <span id="actualPinned"></span></p>
                                    <p><b>Tag:</b> <span id="tag"></span></p>
                                    <br />
                                    <iframe id="reportMap"></iframe>
                                    <br />
                                    <img
                                        id="reportPhoto"
                                        alt="report photo"
                                    />
                                    <video 
                                        width = "320" height = "240" controls = "controls" 
                                        id="reportVideo" alt="report video" type = "video/mp4">
                                    </video>
                                </div>
                                <div id="column2" class="reportColumn2">
                                    <br />
                                    <p><b>Name:</b> <span id="fullName" placeholder="FullName"></span> - #<span id="mobileID"></span></p>
                                    <p><b>Phone:</b> <span id="phone"></span></p>
                                    <p><b>Email:</b> <span id="email"></span></p>
                                    <br />
                                    <b>Report Body:</b> 
                                    <br /><br />
                                    <p id = "body"></p>
                                    <br />
                                    <b>Notes:</b> 
                                    <br /><br />
                                    <div id = "reportNotes"></div>
                                    <br />
                                    <input id = "reportNoteInput" placeholder = "Add Notes..."></input><br/>
                                    <br /><br /><br />
                                    <div class="selectMessage">
                                        <a onclick="myFunction()" class="Respondbtn">Respond</a>
                                        <div id="messageDropdown" class="selectMessage-content">
                                            <option value="TrashSolved"> Trash from that location has been picked up. </option>
                                            <option value="WaterLeakageSolved"> Water leakage from that location has been resolved.</option>
                                            <option value="BrokenLightSolved"> Broken light from that location has been fixed.</option>
                                            <option value="BrokenWindowSolved"> Broken Window from that location has been fixed.</option>
                                            <option value="LightDeficiencySolved"> Light Deficiency from that location has been resolved. </option>
                                            <option value="FixProblem1"> Someone will be there with in an hour. </option>
                                            <option value="FixProblem2"> Someone will be there with in half-hour. </option>
                                        </div>
                                    </div>

                                    <div id="responseButtons">
                                        <!-- <button id="reportRespond">
                                            Respond
                                        </button> -->
                                        <a class="btn large"id="reportOther">
                                            Other Options
                                        </a>
                                        <a class="btn large" id="reportResolve">
                                            Resolved
                                        </a>
                                        <br />
                                        <br />

                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </center>
        <script src="./libs/reportSingle.js"></script>
        <script>
            document.onkeydown = function (e) {
                e = e || window.event;
                var isEscape = false;
                if("key" in e){
                    isEscape = (e.key === "Escape" || e.key === "Esc");
                } else{
                    isEscape = (e.keyCode === 27);
                }
                if(isEscape){ // Exit out of report modal if applicable
                    if(document.getElementById("report").style.display === "block"){ // only if it is showing.
                        var span = document.getElementById("closeReport")
                        var click = new Event('click');
                        span.dispatchEvent(click);
                    }
                }
                // TODO: Fix this space-to-play-video code!
                else{
                    var isSpace = false;
                    if("key" in e){
                        isSpace = (e.key === "Space");
                    } else{
                        isSpace = (e.keyCode === 32);
                    }
                    if(isSpace){
                        var video = document.getElementById("reportVideo");
                        if(document.getElementById("report").style.display === "block"){ // If the modal is being shown
                            if(video.paused){
                                video.play;
                            } else{
                                video.pause;
                            }
                        }
                    }
                }
                
            };
        </script>
        <audio
            id="incomingTag1"
            src="./assets/sounds/Ball.wav"
        ></audio>
        <audio
            id="incomingTag2"
            src="./assets/sounds/Chime.wav"
        ></audio>
        <audio
            id="incomingTag3"
            src="./assets/sounds/Coins.wav"
        ></audio>
        <audio
            id="incomingTag4"
            src="./assets/sounds/Crunch.wav"
        ></audio>
        <audio
            id="incomingTag5"
            src="./assets/sounds/Maraca.wav"
        ></audio>
        <audio
            id="incomingTag6"
            src="./assets/sounds/Shuffle.wav"
        ></audio>
        <audio
            id="incomingTag0"
            src="./assets/sounds/Stapler.wav"
        ></audio>
        <!--END REPORT MODAL-->
        <script src="./libs/reportListRefresher.js"></script>
        <script src="./libs/pagination.js"></script>
        <script src="./libs/reportList.js"></script>
    </body>
</html>
