<!--
    Synopsis of all incoming reports from mobile users. Displays all information 
    in a condensed fashion in an effective yet space-efficient design. Allows
    the ability for detailed filtering of reports. 
    Contents:
    - Scrollable list of reports
        - Icons displaying status of unopened/unsolved/solved
        - Summary of data fields
    - Page controls to manipulate list of reports
    - Filtering options
    - Search button to apply filters
    - [Standardized] Bottom border
    - [Standardized] Navagation bar - set to Dashboard
-->

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>CruzSafe: Reports</title>
        <!--Import Stylesheet-->
        <link
            href="./stylesheets/main.css"
            type="text/css"
            rel="stylesheet"
        />
        <link
            href="./stylesheets/reports.css"
            type="text/css"
            rel="stylesheet"
        />
        <!--Imports External Icon Font Library-->
        <!--TODO: Install all needed Icons & remove external dependency-->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        />
    </head>
    <body>
        <script src="./libs/NavLib.js"></script>
        <script>
            var tid = "";
            document.addEventListener('DOMContentLoaded', function(){
                setupReports(document);
            });

            // Sets up Timer to call function every 30 seconds;
            // Time is in milliseconds
            if(tid === ""){
                tid = setInterval(determineSetup,30000);
            }

            function determineSetup(){
                const filterElements = ["filterTag","filterIncidentID","filterDate","filterTime","filterStatus","filterBody","filterLocation","filterCoordinates","filterUnchangedLocation","filterAttachments","filterMobileID","filterFirstName","filterLastName","filterEmail","filterPhone","filterExpire"];
                var filtersSet = false;
                for(var i = 0; i<filterElements.length; i++){
                    if(document.getElementById(filterElements[i]).value != (null|"")){
                        filtersSet = true;
                        break;
                    }
                }
                // Will prevent auto-refresh of list when user is attempting to search for something
                if(!filtersSet){
                    setupReports(document);
                }
            }
        </script>
        <!--Header-->
        <div class="topnav" id="topNav">
            <a href="./homepage.html"
                ><i class="fa fa-home" aria-hidden="true"></i> Home</a
            >
            <a class="active" href="./reports.html"
                ><i class="fa fa-folder" aria-hidden="true"></i> Reports</a
            >
            <a href="./analytics.html"
                ><i class="fa fa-pie-chart" aria-hidden="true"></i> Analytics</a
            >
            <a href="./admin.html">
                <i class="fa fa-user-circle-o" aria-hidden="true"></i> Admin</a>
            <a href="./"
                ><i class="fa fa-sign-out" aria-hidden="true"></i> Sign-Out</a
            >
            <a href="javascript:void(0);" class="icon" onclick="toggleTopNav()">
                <i class="fa fa-bars"></i>
            </a>
        </div>
        <!--Body-->
        <div class="row">
            <div id="filterOptions" class="text_box">
                <h2>Filters:</h2>
                <input id = "filterTag" placeholder="Tag"></input><br/>
                <input id = "filterIncidentID" placeholder="Incident id(s)"></input> <br/>
                <input id = "filterDate" placeholder="Report date (MM-DD-YYYY)"></input><br/>
                <input id = "filterTime" placeholder="Report time (HH:MM)"></input><br/>
                <input id = "filterBody" placeholder="Body contains"></input><br/>
                <input id = "filterLocation" placeholder="Location"></input><br/>
                <input id = "filterCoordinates" placeholder="Coordinates"></input><br/>         
                <input id = "filterMobileID" placeholder="Mobile user id(s)"></input><br/>
                <input  id = "filterFirstName" placeholder="First name"></input><br/>
                <input id = "filterLastName" placeholder="Last name"></input><br/>
                <input  id = "filterEmail" placeholder="Email (Enter xxx@ucsc.edu)"></input><br/>
                <input  id = "filterPhone" placeholder="Phone (Enter 555555555)"></input><br/>
                <input id = "filterExpire" placeholder="Expiring within day"></input><br/><br/>
                <p>Location method: </p>
                <select id="filterUnchangedLocation" autocomplete="off">
                    <option value="" selected="selected">Any</option>
                    <option value="device reported">Device reported</option>
                    <option value="pinned location">Pinned location</option>
                </select>
                <br/>
                <p>Status:
                        <select id="filterStatus" autocomplete="off">
                            <option value="" selected="selected">Any</option>
                            <option value="New">New</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </p>
                    <br/>
                <p>Attachments: </p>
                <select id="filterAttachments" autocomplete="off">
                    <option value="" selected="selected">Any</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <br/>
                <br/>   
                <button onclick = "applyFilters()" id = "applyFilters" >Apply Filters</button> <button onclick = "location.reload()" id = "resetPage">Reset</button>
            </div>
            <!--Filter Code-->
            <script>
                /*
                    Takes in button ID that initiates the dropdown; this button will have its text replaced by given text.
                    This text will be read by report.js upon selecting of apply filters; 
                    if it is (Not chosen), nothing is added to dictionary.
                */
                function applySelected(dropbtnID, btn){
                    dropbtn = document.getElementById(dropbtnID);
                    dropbtn.innerHTML = btn.innerHTML;
                }

                /*
                    Grabs all of the text in filter fields and converts into a dictionary 
                    which then sends to reports.js which calls API and modifies the list of reports.
                */
                function applyFilters(){
                    // List of all ids of elements to grab text from. 
                    const filterElements = ["filterTag","filterIncidentID","filterDate","filterTime","filterStatus","filterBody","filterLocation","filterCoordinates","filterUnchangedLocation","filterAttachments","filterMobileID","filterFirstName","filterLastName","filterEmail","filterPhone","filterExpire"];
                    var filterDict = {};  // Create the dictionary. 
                    for(i = 0; i < filterElements.length;i++) {// fill the dictionary
                        element = document.getElementById(filterElements[i]);
                        // With a proper dropdown menu, no longer need to check for the text of the old one
                        // element.value should return the value of any input type elements (text fields + dropboxes qualify)
                        var text = element.value; 
                        if(text != ""){  // If not empty/not chosen for dropdown
                            filterDict[filterElements[i]] = text; // filterElement:value
                        }
                        else{
                            filterDict[filterElements[i]] = null;
                        }
                    }
                    // Error checking area! Add more modules in the future.
                    // NOte: this one is broken. 
                    if((Number.isInteger(filterDict["filterIncidentID"] == false) && filterDict["filterIncidentID"] != null)){
                        alert('Incident ID entry must be a number!');
                    }
                    // elif(){}
                    else{
                        filterReports(filterDict, document)// Else all items are good. Send to filterReports.
                    }
                }
            </script>
            <div id="reportColumn" class="column">
                <div id= "reportHeader">
                    <span id = buttonResolvedUnresolved>Status</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonIncidentIDText>Inc#</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonReportTSText>Date + Time</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonTagText>Tag</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonLocationText>Location</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonFullNameText>Last, First name</span>
                    <span id = buttonSplitText></span>
                    <span id = buttonBodyText>Body</span>
                </div>
                <div id= "reportList"></div> <!--Div to be filled by setupReports()-->
                <center>
                    <div id= "navigationButtons" >
                        <button>first</button>
                        <button>prev</button>
                        <button>next</button>
                        <button>last</button>
                    </div>
                </center>
            </div>
        </div>
        <!--Footer-->
        <!-- <div class="footer">
            <div style="margin-top:5; margin-bottom:5">
                <p style="text-align: center">CruzSafe</p>
            </div>
        </div> -->

        <!--REPORT MODAL; USE WITH "report.js" METHODS!-->
        <center>
            <div id="report" class="modal">
                <form class="modal-content animate" method="POST">
                    <div class="imgcontainer">
                        <!--Close Button; closes Modal-->
                        <span
                            onclick="hideReport()"
                            class="close"
                            title="Close Modal"
                            ><i class="fa fa-times"></i
                        ></span>
                        <!--Report Content-->
                        <div id="reportContent" class="container">
                            <div class="reportRow">
                                <div id="column1" class="reportColumn1">
                                    <p>
                                        <b>Incident:</b> #<span id = "incidentID"></span> <b id="resolvedUnresolved"></b>
                                    </p>
                                    <p><b>Date:</b> <span id="reportTS"></span></p>
                                    <p><b>Time:</b> <span id="reportTS2"></span></p>
                                    <p><b>Location:</b> <span id="location"></span> <span id="actualPinned"></span></p>
                                    <p><b>Tag:</b> <span id="tag"></span></p>
                                    <br />
                                    <iframe id="reportMap"></iframe>
                                    <br />
                                    <img
                                        id="reportPhoto"
                                        src="./assets/images/report_photo_two.png"
                                        alt="report photo"
                                    />
                                </div>
                                <div id="column2" class="reportColumn2">
                                    <br />
                                    <p><b>Name:</b> <span id="fullName" placeholder="FullName"></span> - #<span id="mobileID"></span></p>
                                    <p><b>Phone:</b> <span id="phone"></span></p>
                                    <p><b>Email:</b> <span id="email"></span></p>
                                    <br />
                                    <b>Report Body:</b> 
                                    <br /><br />
                                    <p id = "body"></p>
                                    <br />
                                    <div id="responseButtons">
                                        <button id="reportRespond">
                                            Respond
                                        </button>
                                        <button id="reportOther">
                                            Other Options
                                        </button>
                                        <button id="reportResolve">
                                            Resolved
                                        </button>
                                        <br />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </center>
        <script src="./libs/report.js"></script>
        <!--END REPORT MODAL-->
    </body>
</html>
